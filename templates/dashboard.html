{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-tachometer-alt me-2"></i>Dashboard</h2>
    <div>
        {% if has_pngs %}
        <a href="{{ url_for('download_pngs') }}" class="btn btn-success">
            <i class="fas fa-file-archive me-1"></i>Download All PNGs
        </a>
        {% endif %}
    </div>
</div>

<div class="row g-4">
    <!-- PDF Conversion Section -->
    <div class="col-lg-6">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0"><i class="fas fa-file-pdf me-2"></i>PDF to PNG Conversion</h4>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('upload_pdf') }}" enctype="multipart/form-data" class="mb-4">
                    <div class="mb-3">
                        <label for="pdfFile" class="form-label">Upload PDF Files</label>
                        <input class="form-control" type="file" id="pdfFile" name="file" accept=".pdf" multiple required>
                        <div class="form-text">Select one or more PDF files to convert</div>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-upload me-1"></i>Upload PDFs
                    </button>
                </form>

                {% if pdf_files %}
                <div class="mb-3">
                    <h5>Uploaded PDF Files</h5>
                    <ul class="list-group">
                        {% for file in pdf_files %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span><i class="fas fa-file-pdf text-danger me-2"></i>{{ file }}</span>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                
                <form method="POST" action="{{ url_for('convert_pdf') }}">
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-exchange-alt me-1"></i>Convert to PNG
                    </button>
                </form>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Bid Summary Report Section -->
    <div class="col-lg-6">
        <div class="card shadow-sm">
            <div class="card-header bg-success text-white">
                <h4 class="mb-0"><i class="fas fa-file-excel me-2"></i>Bid Summary Report Generator</h4>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('upload_excel') }}" enctype="multipart/form-data" class="mb-4">
                    <div class="mb-3">
                        <label for="excelFile" class="form-label">Upload Bid Data File</label>
                        <input class="form-control" type="file" id="excelFile" name="file" accept=".xlsx,.xls" required>
                        <div class="form-text">Upload an Excel file with bid data to generate summary reports</div>
                    </div>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-upload me-1"></i>Upload Bid Data
                    </button>
                </form>

                {% if excel_files %}
                <div class="mb-3">
                    <h5>Uploaded Bid Data File</h5>
                    <ul class="list-group">
                        {% for file in excel_files %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span><i class="fas fa-file-excel text-success me-2"></i>{{ file }}</span>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}

                {% if excel_files %}
                <form method="POST" action="{{ url_for('generate_report') }}" class="mb-3">
                    <button type="submit" class="btn btn-info">
                        <i class="fas fa-chart-bar me-1"></i>Generate Bid Summary
                    </button>
                </form>
                {% endif %}

                {% if report_files %}
                <div class="mb-3">
                    <h5>Available Bid Summary Reports</h5>
                    <ul class="list-group">
                        {% for file in report_files %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span><i class="fas fa-file-excel text-info me-2"></i>{{ file }}</span>
                            <a href="{{ url_for('download_report', filename=file) }}" class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-download"></i>
                            </a>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Sales Performance Report Section -->
    <div class="col-lg-6 mt-4">
        <div class="card shadow-sm">
            <div class="card-header bg-warning text-white">
                <h4 class="mb-0"><i class="fas fa-chart-line me-2"></i>Sales Performance Reports</h4>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('upload_sales_data') }}" enctype="multipart/form-data" class="mb-4">
                    <div class="mb-3">
                        <label for="salesDataFile" class="form-label">Upload Sales Data File</label>
                        <input class="form-control" type="file" id="salesDataFile" name="file" accept=".xlsx,.xls" required>
                        <div class="form-text">Upload sales data Excel file (must contain Sheet2 with metrics)</div>
                    </div>
                    <button type="submit" class="btn btn-warning">
                        <i class="fas fa-upload me-1"></i>Upload Sales Data
                    </button>
                </form>

                {% if sales_data_files %}
                <div class="mb-3">
                    <h5>Uploaded Sales Data File</h5>
                    <ul class="list-group">
                        {% for file in sales_data_files %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span><i class="fas fa-file-excel text-warning me-2"></i>{{ file }}</span>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}

                {% if sales_data_files %}
                <form method="POST" action="{{ url_for('generate_sales_report') }}" class="mb-3">
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-chart-pie me-1"></i>Generate Performance Report
                    </button>
                </form>
                {% endif %}

                {% if sales_report_files %}
                <div class="mb-3">
                    <h5>Available Sales Reports</h5>
                    <ul class="list-group">
                        {% for file in sales_report_files %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span><i class="fas fa-file-excel text-success me-2"></i>{{ file }}</span>
                            <a href="{{ url_for('download_sales_report', filename=file) }}" class="btn btn-sm btn-outline-success">
                                <i class="fas fa-download"></i>
                            </a>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- VBA PDF Export Section -->
    <div class="col-lg-6 mt-4">
        <div class="card shadow-sm">
            <div class="card-header bg-info text-white">
                <h4 class="mb-0"><i class="fas fa-file-excel me-2"></i>Excel to PDF Export</h4>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('process_vba_excel') }}" enctype="multipart/form-data" class="mb-4">
                    <div class="mb-3">
                        <label class="form-label">1. Select Excel File</label>
                        <input class="form-control" type="file" name="file" accept=".xlsx,.xlsm" required>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">2. Select Report Type</label>
                        <select name="vba_type" class="form-select" required>
                            <option value="sales">Sales Summary Report</option>
                            <option value="bid">Bid Summary Report</option>
                        </select>
                    </div>
                    
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-file-pdf me-1"></i> Convert to PDF
                    </button>
                </form>

                {% if 'vba_zip_file' in session %}
                <div class="alert alert-success">
                    <i class="fas fa-check-circle me-2"></i> 
                    Conversion complete! {{ session['vba_generated_count'] }} PDFs generated.
                </div>
                <a href="{{ url_for('download_all_vba_pdfs') }}" class="btn btn-success w-100">
                    <i class="fas fa-file-archive me-1"></i> Download All PDFs (ZIP)
                </a>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Rough PDF to Excel Converter Section -->
<div class="col-lg-6 mt-4">
    <div class="card shadow-sm">
        <div class="card-header bg-dark text-white">
            <h4 class="mb-0"><i class="fas fa-gem me-2"></i>Rough PDF to Excel Converter</h4>
        </div>
        <div class="card-body">
            <div class="alert alert-info">
                <strong>Instructions:</strong> Upload your rough diamond inventory PDF to convert to Excel.
                Works entirely in your browser - no data is uploaded to any server.
            </div>
            
            <div class="mb-3">
                <label class="form-label">Upload PDF File</label>
                <input class="form-control" type="file" id="pdfUpload" accept=".pdf" required>
                <div class="form-text">Supported formats: Standard diamond inventory PDFs</div>
            </div>
            
            <div id="pdf-processing" class="d-none">
                <div class="progress mb-3">
                    <div id="pdf-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" 
                         role="progressbar" style="width: 0%"></div>
                </div>
                <p id="pdf-status" class="text-center">Processing PDF...</p>
            </div>
            
            <div id="diamond-results" class="d-none">
                <div class="company-info mb-3 p-3 bg-light rounded">
                    <h3 id="company-name">SIA JEWELS</h3>
                    <p><strong>Contract Number:</strong> <span id="contract-number">05500798</span></p>
                    <p><strong>Date:</strong> <span id="inventory-date"></span></p>
                </div>

                <div class="table-responsive">
                    <table class="table table-bordered table-hover table-sm" id="diamondTable">
                        <thead class="table-primary">
                            <tr>
                                <th>S.No</th>
                                <th>Assortment Description</th>
                                <th>Weight (ct)</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            <!-- Data will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>

                <div class="d-flex justify-content-between mt-3">
                    <button class="btn btn-success" onclick="downloadDiamondExcel()">
                        <i class="fas fa-file-excel me-1"></i> Download Excel
                    </button>
                    <button class="btn btn-primary" onclick="downloadDiamondCSV()">
                        <i class="fas fa-file-csv me-1"></i> Download CSV
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Flash Messages Display -->
{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        <div class="mt-4">
            {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        </div>
    {% endif %}
{% endwith %}

{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
// Set current date
document.getElementById('current-date').textContent = new Date().toLocaleDateString();

// Sample diamond data - in a real app you would parse this from PDF text
const diamondData = [
    { sno: "1/1", assortment: "REJ1-GRY 12CT", weight: 12.57 },
    { sno: "1", assortment: "#REJECTIONS 11CT-19CT", weight: 12.57 },
    { sno: "", assortment: "2/1 4BLKCLIV/MB-2C 11CT", weight: 11.69 },
    { sno: "2", assortment: "#4BLK CLIV & MB 11CT-19CT", weight: 11.69 },
    // ... rest of your diamond data ...
    { sno: "68", assortment: "#REJECTION BRN 4GR - 6GR", weight: 289.90 }
];

// Populate table
function populateDiamondTable() {
    const tableBody = document.getElementById('tableBody');
    tableBody.innerHTML = ''; // Clear existing
    
    diamondData.forEach(item => {
        const row = tableBody.insertRow();
        row.insertCell(0).textContent = item.sno;
        row.insertCell(1).textContent = item.assortment;
        const weightCell = row.insertCell(2);
        weightCell.textContent = item.weight.toFixed(2);
        weightCell.classList.add('text-end');
    });
    
    // Add total row
    const totalRow = tableBody.insertRow();
    totalRow.classList.add('table-success', 'fw-bold');
    totalRow.insertCell(0).textContent = '';
    totalRow.insertCell(1).textContent = 'TOTAL';
    const totalWeightCell = totalRow.insertCell(2);
    totalWeightCell.textContent = diamondData.reduce((sum, item) => sum + item.weight, 0).toFixed(2);
    totalWeightCell.classList.add('text-end');
}

// Download as Excel
function downloadDiamondExcel() {
    const wb = XLSX.utils.book_new();
    const wsData = [
        ['SIA JEWELS - Diamond Inventory'],
        ['Contract Number: 05500798'],
        ['Date: ' + new Date().toLocaleDateString()],
        [''],
        ['S.No', 'Assortment Description', 'Weight (ct)'],
        ...diamondData.map(item => [item.sno, item.assortment, item.weight]),
        ['', 'TOTAL', diamondData.reduce((sum, item) => sum + item.weight, 0)]
    ];
    
    const ws = XLSX.utils.aoa_to_sheet(wsData);
    XLSX.utils.book_append_sheet(wb, ws, 'Diamond Inventory');
    XLSX.writeFile(wb, 'Diamond_Inventory.xlsx');
}

// Download as CSV
function downloadDiamondCSV() {
    let csv = "S.No,Assortment,Weight (ct)\n";
    diamondData.forEach(item => {
        csv += `"${item.sno}","${item.assortment}",${item.weight}\n`;
    });
    csv += `"","TOTAL",${diamondData.reduce((sum, item) => sum + item.weight, 0)}`;
    
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'Diamond_Inventory.csv';
    link.click();
}

// Future PDF parsing functionality
document.getElementById('pdfUpload').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    // In a real implementation, you would use PDF.js here to extract text
    // Then parse the text to populate the diamondData array
    alert('PDF parsing functionality coming soon! Currently using sample data.');
});

// Initialize on page load
document.addEventListener('DOMContentLoaded', populateDiamondTable);
</script>
{% endblock %}
